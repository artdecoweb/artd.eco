{
  "title": "How To Load Google Fonts Asynchronously",
  "content": "<div class=\"container\">\n  <div class=\"row\">\n    <div col>\n      \n\n<h1 id=\"how-to-load-google-fonts-asynchronously\">How To Load Google Fonts Asynchronously</h1>\n\n<p class=\"H1Lead lead\"> &gt; Part I of <em>Advanced Google Font</em>. Go to Part II: <a href=\"the-best-way-to-load-google-fonts-asynchronously.html\">\n   The Best Way To Load Google Fonts Asynchronously</a> and Part III: <a href=\"embedding-critical-path-fonts.html\">Embedding Critical Path Fonts</a>.</p>\n\n<div class=\"row mb-3\">\n  <div class=\"col-2 col-sm-2 col-lg-1\">\n    <img class=\"rounded img-fluid\" alt=\"anton photo\" src=\"data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='100' height='100'/%3E\" data-io>\n    <noscript><img class=\"rounded img-fluid\" alt=\"anton photo\" src=\"avatar/anton3.jpg\"></noscript>\n  </div>\n  <div class=\"col-10 col-sm-7\" style=\"border-bottom: 1px solid grey;\">\n    <p class=\"text-right\" style=\"color: grey;\">\n      <span>Anton Dmukhovskiy, Senior Software Developer</span><br>\n      <span>23 October 2019</span>  \n      <span class=\"SplendidSharingButtons\"><span id=\"cd871\"><span class=\"d-inline-block\" style=\"height:24px\" data-loading>Loading sharing buttons...</span><noscript>Please enable JavaScript to Share</noscript></span></span>\n    </p>\n  </div>\n  <div class=\"col-sm-3 col-lg-4\">\n    <img class=\"d-block\" alt=\"views counter\" src=\"https://api.artd.eco/counter.svg\">Topics: <a href=\"topics.html#page-speed-optimisation\">page speed optimisation</a>, <a href=\"topics.html#web-fonts\">web fonts</a>\n  </div>\n</div>\n\n<p>Traditionally my job as a developer was to build libraries in form of NPM packages and other software infrastructure for my <a href=\"/\">Node.JS Development Company</a>, <span class=\"TM1\">Art </span>\n <span class=\"TM1\">Deco™</span>. However the most fun part of programming always was to make products for the Web, such as websites and integrate them with 3rd party APIs. Today, I focus on another aspect of web development, that is making web pages, that could even be static, but optimised for the modern day requirement of a web site: it must load extremely fast, and put performance in the first place.</p>\n\n<div class=\"position-relative mb-3 text-center\" id=\"c65b9\">\n  <img class=\"img-fluid\" alt=\"Advanced Google Font banner\" src=\"data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='550' height='400'/%3E\" data-io>\n  <noscript>\n    <img class=\"img-fluid\" alt=\"Advanced Google Font banner\" src=\"best-google-font/graphics/agf.png\">\n  </noscript>\n</div>\n\n<p>Because fast pages please users, the conversion rates are increased and SEO rankings receive a boost, therefore each no matter how small piece of optimisation can lead to an additional sale. So I was pondering of what actually the best way to load <em>Google Fonts</em> is? In this article, I'll walk you through considerations of each steps on the ladder of progressively perfect optimisation of <em>Google Fonts</em> loading, and show the best way to load <em>Google Fonts</em> asynchronously that I've come up with. The method that I call <a class=\"TM3\" href=\"how-to-load-google-fonts-asynchronously.html\">\n   <span class=\"TM1 TM2\">Advanced </span>\n   <span class=\"TM1 TM2\">Google </span>\n   <span class=\"TM1 TM2\">Font</span></a> not only allows to load the web font stylesheet asynchronously but also:</p>\n\n<!-- <add-file>./graphics/parchment-svg.svg</add-file> -->\n\n\n<div>\n  <img class=\"PB d-block\" style=\"width:100%; height:auto\" alt=\"papyrus background\" data-io>\n  <noscript>\n    <img class=\"PB d-block\" style=\"width:100%; height:auto\" alt=\"papyrus background\" src=\"best-google-font/svg/parchment-top.svg\">\n  </noscript>\n  <div class=\"position-relative\" id=\"Advantages\">\n    <img class=\"PA PC\" alt=\"papyrus background\" data-io>\n    <noscript>\n      <img class=\"PA PC\" alt=\"papyrus background\"\n        src=\"best-google-font/graphics/parchment-svg.svg\">\n    </noscript>\n\n    <!-- the vertical -->\n    <img class=\"PB PC\" alt=\"papyrus background\" data-io>\n    <noscript>\n      <img class=\"PB PC\" alt=\"papyrus background\"\n        src=\"best-google-font/svg/parchment-middle.svg\">\n    </noscript>\n    <ul>\n      <li>Reduces the delay before the font is loaded and can be applied to text, by discovering the most efficient way to <strong>preload</strong> the stylesheet. Have you ever set <span class=\"tm\" style=\"background-color:#ffd386\">＜link rel=\"preload\" onload=\"this.rel = 'stylesheet'\"＞</span>? Read on to find out if that's optimal.</li>\n      <li>Eliminates extraneous reflows of the page that happen a) after the stylesheet is applied, and b) after each font and its variations are downloaded (think 3+ reflows for 2 fonts you're loading), thus <strong>unblocking</strong> the main thread and improving the overall page load time.</li>\n      <li>Shows all variations of a font <strong>at the same time</strong>, without parts of text jumping on the page, which might be annoying to the user. The Flash of Unstyled Text (<em>FOUT</em>) is one thing, which is somewhat bearable by the user, but when many parts of the text (italic, bold) jump and flash it kind of looks unprofessional because it interferes with users' attention span.</li>\n    </ul>\n  </div>\n  <img class=\"PB d-block\" style=\"width:100%; height:auto\" alt=\"papyrus background\" data-io>\n  <noscript>\n    <img class=\"PB d-block\" style=\"width:100%; height:auto\" alt=\"papyrus background\" src=\"best-google-font/svg/parchment-bottom.svg\">\n  </noscript>\n</div>\n\n<p>As a bonus at the end, I will show you a hack how to embed a font on a webpage for the critical path view, that is more advanced than just embedding a CSS with <span class=\"tm\">data:application/font</span>-encoded base64 string with it, which might still result in a <em>FOUT</em>, but my bonus workaround removes the <em>FOUT</em> completely.</p>\n\n<p>This article is not just about fonts loading, it's generally good to understand the processes underlying the page load process. In fact, some of the reflows that I'm going to talk about will take 20-60ms on a fast computer, and some will say that it's too pedantic to even bother with that. However, I was conducting my experiments on a late-2008 Macbook (which I actually use on daily basis), and there they took 120ms. Although we live in an age of constantly faster technology, there are also older and mobile devices which are generally slower. On a newer iMac, I had to switch on CPU throttling to 6x to achieve the same result.</p>\n\n<img style=\"float: right;\" alt=\"Lighthouse 100 performance score\" data-io>\n<noscript>\n  <img style=\"float: right;\" alt=\"Lighthouse 100 performance score\" src=\"best-google-font/gif/100.gif\">\n</noscript>\n\n<p>But I don't think it's irrelevant to slow down sometimes: seeing things in \"slo-mo\" will help to develop understanding of steps in which a page loads such as, when fonts referenced in the stylesheet start downloading, differences between sync and async stylesheets, and why we might want to embed all styles on the page. The font method itself will increase the <em>Lighthouse</em> rating, and fix its \"<em>eliminate render-blocking resources</em>\" warning, and whereas at night fonts can load in 100ms so that the benefit is slight, at noon time of a work day that could easily be 300-500ms and become the bottleneck of the website rendering.</p>\n\n<p class=\"SectionBreak\">\n  <a title=\"Back To Top\" href=\"#top\">\n    <img alt=\"section break\"\n      src=\"data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='40' height='15'/%3E\" data-io>\n    <noscript><img alt=\"section break\" src=\"/section-breaks/0.svg\"></noscript></a>\n</p>\n\n<h3 id=\"table-of-contents\">Table Of Contents</h3>\n\n<p>There are 2 parts: this first one, with the description of how to achieve asynchronous web font loading, and the second one, introducing some JS to load the Google Font in the most efficient manner possible.</p>\n\n<ul>\n  <li><a href=\"#standard-sync-loading\">Standard Sync Loading</a></li>\n  <li><a href=\"#async-google-font-loading\">Async Google Font Loading</a></li>\n  <li><a href=\"#summary-to-part-i\">Summary To Part I</a></li>\n</ul>\n<ul>\n  <li><a href=\"the-best-way-to-load-google-fonts-asynchronously.html#advanced-loading-lemuriafont\"></li>\n   Advanced Loading: @lemuria/font</a>\n  <li><a href=\"the-best-way-to-load-google-fonts-asynchronously.html#comparison\">Comparison of Methods</a></li>\n</ul>\n<ul>\n  <li><a href=\"embedding-critical-path-fonts.html\">Embedding Critical Path Fonts</a></li>\n  <li><a href=\"embedding-critical-path-fonts.html#generator\">Generator</a></li>\n</ul>\n\n<p class=\"SectionBreak\">\n  <a title=\"Back To Top\" href=\"#top\">\n    <img alt=\"section break\"\n      src=\"data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='40' height='13'/%3E\" data-io>\n    <noscript><img alt=\"section break\" src=\"/section-breaks/1.svg\"></noscript></a>\n</p>\n\n\n<!-- <img class=\"img-fluid\" alt=\"Advanced Font Loading\" src=\"/advanced.jpg\" placeholder-auto> -->\n\n<h2 id=\"standard-sync-loading\">Standard Sync Loading</h2>\n\n<p>Let's start with the basics. We want a Google Font on our website. This means going to <a href=\"https://fonts.google.com\">fonts.google.com</a> and picking up specimens that we want our pages to display with, for example, the fonts that I use here are an Art Deco font <strong>Limelight</strong> for headings and <strong>Gentium Basic</strong> (with variations) for paragraphs:</p>\n\n<pre id=\"c16f7\"><code class=\"xml hljs\">&lt;link rel=\"stylesheet\"\n  href=\"https://fonts.googleapis.com/css?family=Limelight|Gentium+Basic:400,400i,700&amp;display=swap\"&gt;</code></pre>\n\n<p>The advantage of this cloud service is that <em>Google Fonts</em> will load a dynamic stylesheet depending on a user's browser, and provide optimised fonts, which are constantly improved in newer versions. We also don't have to host the fonts ourselves, and work on creating such stylesheets manually. E.g., below is the stylesheet that was returned for my Chrome on MacOS. It also has 2 <span class=\"tm\">unicode-ranges</span>, <span class=\"tm\">latin</span> and <span class=\"tm\">latin-ext</span> so that the browser will check if there are any characters from the extended set, to decide whether this extra font is needed. Tables with such ranges could be looked up <a href=\"https://jrgraphix.net/r/Unicode/0100-017F\">here</a>.</p>\n\n<details>\n<summary>\n<em>Google Fonts Stylesheet</em>\n<pre id=\"c1d47\"><code class=\"css hljs\">/* latin-ext */\n@font-face {\n  font-family: 'Limelight';\n  font-style: normal;\n  font-weight: 400;\n  font-display: swap;\n  src: local('Limelight'), url(https://fonts.gstatic.com/s/limelight/v10/XLYkIZL7aopJVbZJHDuoNOlHjHUmTUFt.woff2) format('woff2');\n  unicode-range: U+0100-024F, U+0259, U+1E00-1EFF, U+2020, U+20A0-20AB, U+20AD-20CF, U+2113, U+2C60-2C7F, U+A720-A7FF;\n}\n/* latin */\n@font-face {\n  font-family: 'Limelight';\n  font-style: normal;\n  font-weight: 400;\n  font-display: swap;\n  src: local('Limelight'), url(https://fonts.gstatic.com/s/limelight/v10/XLYkIZL7aopJVbZJHDuoOulHjHUmTQ.woff2) format('woff2');\n  unicode-range: U+0000-00FF, U+0131, U+0152-0153, U+02BB-02BC, U+02C6, U+02DA, U+02DC, U+2000-206F, U+2074, U+20AC, U+2122, U+2191, U+2193, U+2212, U+2215, U+FEFF, U+FFFD;\n}\n\n/* CLICK TO SHOW FULL STYLESHEET */</code></pre>\n</summary>\n\n<pre id=\"c1d471\"><code class=\"css hljs\">/* latin-ext */\n@font-face {\n  font-family: 'Limelight';\n  font-style: normal;\n  font-weight: 400;\n  font-display: swap;\n  src: local('Limelight'), url(https://fonts.gstatic.com/s/limelight/v10/XLYkIZL7aopJVbZJHDuoNOlHjHUmTUFt.woff2) format('woff2');\n  unicode-range: U+0100-024F, U+0259, U+1E00-1EFF, U+2020, U+20A0-20AB, U+20AD-20CF, U+2113, U+2C60-2C7F, U+A720-A7FF;\n}\n/* latin */\n@font-face {\n  font-family: 'Limelight';\n  font-style: normal;\n  font-weight: 400;\n  font-display: swap;\n  src: local('Limelight'), url(https://fonts.gstatic.com/s/limelight/v10/XLYkIZL7aopJVbZJHDuoOulHjHUmTQ.woff2) format('woff2');\n  unicode-range: U+0000-00FF, U+0131, U+0152-0153, U+02BB-02BC, U+02C6, U+02DA, U+02DC, U+2000-206F, U+2074, U+20AC, U+2122, U+2191, U+2193, U+2212, U+2215, U+FEFF, U+FFFD;\n}\n\n/* CLICK TO SHOW FULL STYLESHEET */\n\n/* latin-ext */\n@font-face {\n  font-family: 'Gentium Basic';\n  font-style: italic;\n  font-weight: 400;\n  font-display: swap;\n  src: local('Gentium Basic Italic'), local('GentiumBasic-Italic'), url(https://fonts.gstatic.com/s/gentiumbasic/v11/WnzjHAw9aB_JD2VGQVR80We3LAi5hBo7QoCBZCxP.woff2) format('woff2');\n  unicode-range: U+0100-024F, U+0259, U+1E00-1EFF, U+2020, U+20A0-20AB, U+20AD-20CF, U+2113, U+2C60-2C7F, U+A720-A7FF;\n}\n/* latin */\n@font-face {\n  font-family: 'Gentium Basic';\n  font-style: italic;\n  font-weight: 400;\n  font-display: swap;\n  src: local('Gentium Basic Italic'), local('GentiumBasic-Italic'), url(https://fonts.gstatic.com/s/gentiumbasic/v11/WnzjHAw9aB_JD2VGQVR80We3LAi5iho7QoCBZA.woff2) format('woff2');\n  unicode-range: U+0000-00FF, U+0131, U+0152-0153, U+02BB-02BC, U+02C6, U+02DA, U+02DC, U+2000-206F, U+2074, U+20AC, U+2122, U+2191, U+2193, U+2212, U+2215, U+FEFF, U+FFFD;\n}\n/* latin-ext */\n@font-face {\n  font-family: 'Gentium Basic';\n  font-style: normal;\n  font-weight: 400;\n  font-display: swap;\n  src: local('Gentium Basic'), local('GentiumBasic'), url(https://fonts.gstatic.com/s/gentiumbasic/v11/Wnz9HAw9aB_JD2VGQVR80We3LAOJiBA8YIKxZQ.woff2) format('woff2');\n  unicode-range: U+0100-024F, U+0259, U+1E00-1EFF, U+2020, U+20A0-20AB, U+20AD-20CF, U+2113, U+2C60-2C7F, U+A720-A7FF;\n}\n/* latin */\n@font-face {\n  font-family: 'Gentium Basic';\n  font-style: normal;\n  font-weight: 400;\n  font-display: swap;\n  src: local('Gentium Basic'), local('GentiumBasic'), url(https://fonts.gstatic.com/s/gentiumbasic/v11/Wnz9HAw9aB_JD2VGQVR80We3LA2JiBA8YII.woff2) format('woff2');\n  unicode-range: U+0000-00FF, U+0131, U+0152-0153, U+02BB-02BC, U+02C6, U+02DA, U+02DC, U+2000-206F, U+2074, U+20AC, U+2122, U+2191, U+2193, U+2212, U+2215, U+FEFF, U+FFFD;\n}\n/* latin-ext */\n@font-face {\n  font-family: 'Gentium Basic';\n  font-style: normal;\n  font-weight: 700;\n  font-display: swap;\n  src: local('Gentium Basic Bold'), local('GentiumBasic-Bold'), url(https://fonts.gstatic.com/s/gentiumbasic/v11/WnzgHAw9aB_JD2VGQVR80We3JLasnTMebaiLbBR2kw.woff2) format('woff2');\n  unicode-range: U+0100-024F, U+0259, U+1E00-1EFF, U+2020, U+20A0-20AB, U+20AD-20CF, U+2113, U+2C60-2C7F, U+A720-A7FF;\n}\n/* latin */\n@font-face {\n  font-family: 'Gentium Basic';\n  font-style: normal;\n  font-weight: 700;\n  font-display: swap;\n  src: local('Gentium Basic Bold'), local('GentiumBasic-Bold'), url(https://fonts.gstatic.com/s/gentiumbasic/v11/WnzgHAw9aB_JD2VGQVR80We3JLasnT0ebaiLbBQ.woff2) format('woff2');\n  unicode-range: U+0000-00FF, U+0131, U+0152-0153, U+02BB-02BC, U+02C6, U+02DA, U+02DC, U+2000-206F, U+2074, U+20AC, U+2122, U+2191, U+2193, U+2212, U+2215, U+FEFF, U+FFFD;\n}</code></pre>\n</details>\n\n<p>The <span class=\"tm\">font-display: swap</span> property is quite important as it allows to show the initial text without having to wait for fonts to load. It's a <a href=\"https://caniuse.com/#search=font-display\">new feature</a> and is not supported on Edge. In spite the fact that people assume that Google's infrastructure is resilient and can serve requests immediately, it's not always the case, and especially on 3G connections, at peak times, when moving in a car, people will open a website, and will be presented with a blank screen without text, until fonts are loaded. The <span class=\"tm\">font-display: swap</span> solves this problem. My method of loading <em>Google Fonts</em> asynchronously, also implicitly provides a solution to the swap problem, and can be considered as a polyfill for this CSS property for <em>IE</em> and <em>Edge</em>.</p>\n\n<p>I'm going to experiment on the front page of my website, <a href=\"/\">artd.eco</a>. The traditional sync inclusion of the <em>Google Fonts</em> results in the following loading process that for the user appears to be consisting of 3 steps:</p>\n\n</div></div></div>\n<div class=\"container-fluid position-relative\">\n  <div class=\"row\">\n    <div class=\"order-2 d-flex align-items-center justify-content-center flex-column mb-3 p-3 rounded position-relative overflow-hidden col\" id=\"fig-9848\">\n      <div class=\" Parallax\" data-loading style=\"z-index: -1;\" id=\"c709f\"></div>\n      <div style=\"z-index: -1;\" class=\"Parallax\"></div>\n      <noscript>\n        <div class=\" Parallax\" style=\"background-image: url(/img/letters/background.png); z-index: -1;\"></div>\n      </noscript>\n      <p class=\"text-center\">\n        <img class=\"border rounded img-fluid\" alt=\"Figure 1: Loading Google Font synchronously.\" src=\"data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='812' height='461'/%3E\" data-io>\n        <noscript>\n          <img class=\"border rounded img-fluid\" alt=\"Figure 1: Loading Google Font synchronously.\" src=\"best-google-font/graphics/font1.gif\">\n        </noscript>\n      </p>\n      <h5 id=\"figure-1-loading-google-font-synchronously\" class=\"m-0 d-inline-block\"\n        style=\"background: white;\">\n        Figure 1: Loading Google Font synchronously.\n      </h5>\n    </div>\n  </div>\n  <div class=\"position-absolute\" style=\"opacity: 0; top: 1rem; right: 1rem;\" id=\"ce513\">\n    <a class=\"btn btn-danger\" href=\"#\">Go Back</a>\n  </div>\n</div>\n<div class=\"container\"><div class=\"row\"><div class=\"col\">\n\n<!-- <add-file></add-file> -->\n\n<div class=\"mb-3 Revision\">\n  <ol style=\"background-image: url('../articles/img/sketch-yellow.svg');\">\n    \n      <li>No fonts are downloaded yet, and because of <span class=\"tm\">font-display: swap</span>, we see the fallback fonts. Without the swap property, there would be no text.</li>\n      <li>The <strong>Limelight</strong> font is loaded for the heading, and the page is redrawn.</li>\n      <li>The <strong>GentiumBasic</strong> font is loaded for the paragraph, and the page is redrawn again.</li>\n    \n  </ol>\n  <div class=\"position-absolute\" style=\"width: 1rem; bottom: 0px; top: 0px; right: 1rem; border-left: 1px solid #ec6a9d;\">\n    <img src=\"/img/arrows.svg\">\n  </div>\n</div>\n\n<p>The 3rd step, with GentiumBasic loading, actually consists of 2 steps, the italic version being loaded, and the normal one, but that happens <em>almost</em> at the same time, so I couldn't capture that on GIF. However, what is important is that each arrival of a new font results in page re-rendering and a change of text's styles as well. Rendering happens on the main thread, therefore the browser is blocked and slowed down by each font. The method that I will show, will wait for all fonts to arrive, before applying the stylesheet to the document, which will help to circumvent this aspect of imperfect standard <em>Google Font</em> loading. So what happens under the hood? The performance snapshot below will help to understand how the page is loaded in more details.</p>\n\n</div></div></div>\n<div class=\"container-fluid position-relative\">\n  <div class=\"row\">\n    <div class=\"order-2 d-flex align-items-center justify-content-center flex-column mb-3 p-3 rounded position-relative overflow-hidden col\" id=\"fig-74268\">\n      <div class=\" Parallax\" data-loading style=\"z-index: -1;\" id=\"c709f1\"></div>\n      <div style=\"z-index: -1;\" class=\"Parallax\"></div>\n      <noscript>\n        <div class=\" Parallax\" style=\"background-image: url(/img/letters/background.png); z-index: -1;\"></div>\n      </noscript>\n      <p class=\"text-center\">\n        <img class=\"border rounded img-fluid\" alt=\"Figure 2: Performance measurement of sync Google Font loading.\" src=\"data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='694' height='673'/%3E\" data-io>\n        <noscript>\n          <img class=\"border rounded img-fluid\" alt=\"Figure 2: Performance measurement of sync Google Font loading.\" src=\"best-google-font/graphics/dev1.png\">\n        </noscript>\n      </p>\n      <h5 id=\"figure-2-performance-measurement-of-sync-google-font-loading\" class=\"m-0 d-inline-block\"\n        style=\"background: white;\">\n        Figure 2: Performance measurement of sync Google Font loading.\n      </h5>\n    </div>\n  </div>\n  <div class=\"position-absolute\" style=\"opacity: 0; top: 1rem; right: 1rem;\" id=\"c6965\">\n    <a class=\"btn btn-danger\" href=\"#\">Go Back</a>\n  </div>\n</div>\n<div class=\"container\"><div class=\"row\"><div class=\"col\">\n\n<div class=\"mb-3 Revision\">\n  <ol style=\"background-image: url('../articles/img/sketch-yellow.svg');\">\n    \n      <li>\n        <img class=\"float-right pl-2\" alt=\"css unblocking thread animation\" src=\"data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='153' height='100'/%3E\" data-io>\n        <noscript>\n          <img class=\"float-right pl-2\" alt=\"css unblocking thread animation\" src=\"best-google-font/gif/thread.gif\">\n        </noscript>\n        The font's stylesheet is the first thing to be loaded by the browser, however parsing of HTML does not start before all styles completed their download (you can check that by enabling very slow network throttling &mdash; the parsing does not begin until all external CSS files are loaded). This is definitely an issue since we want to start rending the page immediately if we want it to be <em>performant</em>. This is why <em>google.com</em> does not have any external stylesheets, and their styles are embedded onto the page. There's also a delay before the fonts start to download indicated by the semi-opaque purple rectangle. This is because even the stylesheet is received, the browser doesn't load the fonts until the layout (purple bar).<br><br>\n      </li>\n      <li>The first font, <strong>LimeLight</strong> arrives and triggers recalculate styles, layout, update layer tree, paint and composite layers jobs. The longest is layout and it takes 46ms for 450 nodes, but that would take longer for larger pages. Altogether, the page's is blocked during that time (for about 80ms), preventing the spinning loading indicator from going away.<br><br></li>\n      <li>The second font and its variations <strong>GentiumBasic</strong>, are loaded and applied to text on the page, triggering another 46ms layout, and another thread block. Because fonts arrived at almost the same time, there's only one layout job, but if italic version arrived later, there would have been another block.</li>\n    \n  </ol>\n  <div class=\"position-absolute\" style=\"width: 1rem; bottom: 0px; top: 0px; right: 1rem; border-left: 1px solid #ec6a9d;\">\n    <img src=\"/img/arrows.svg\">\n  </div>\n</div>\n\n<p>The conclusion is that we want to avoid synchronous loading of <em>Google Fonts</em> altogether. We cannot rely on Google to serve web font stylesheets immediately, and on slow network the UI will be completely blocked until the CSS is received. This is true not only for fonts, but for any CSS, therefore <em>Lighthouse</em> will always give this suggestions:</p>\n\n</div></div></div>\n<div class=\"container-fluid position-relative\">\n  <div class=\"row\">\n    <div class=\"order-2 d-flex align-items-center justify-content-center flex-column mb-3 p-3 rounded position-relative overflow-hidden col\" id=\"fig-80\">\n      <div class=\" Parallax\" data-loading style=\"z-index: -1;\" id=\"c709f2\"></div>\n      <div style=\"z-index: -1;\" class=\"Parallax\"></div>\n      <noscript>\n        <div class=\" Parallax\" style=\"background-image: url(/img/letters/background.png); z-index: -1;\"></div>\n      </noscript>\n      <p class=\"text-center\">\n        <img class=\"border-danger border rounded img-fluid\" alt=\"Figure 3: Lighthouse 'Eliminate render-blocking resources' suggestion\" src=\"data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='685' height='339'/%3E\" data-io>\n        <noscript>\n          <img class=\"border-danger border rounded img-fluid\" alt=\"Figure 3: Lighthouse 'Eliminate render-blocking resources' suggestion\" src=\"best-google-font/graphics/lighthouse1.png\">\n        </noscript>\n      </p>\n      <h5 id=\"figure-3-lighthouse-eliminate-render-blocking-resources-suggestion\"\n        class=\"m-0 d-inline-block\" style=\"background: white;\">\n        Figure 3: Lighthouse 'Eliminate render-blocking resources' suggestion\n      </h5>\n    </div>\n  </div>\n  <div class=\"position-absolute\" style=\"opacity: 0; top: 1rem; right: 1rem;\" id=\"c8e80\">\n    <a class=\"btn btn-danger\" href=\"#\">Go Back</a>\n  </div>\n</div>\n<div class=\"container\"><div class=\"row\"><div class=\"col\">\n\n<p>Because Google audits pages it craws for performance, and uses the page speed as a ranking factor, we want to follow the suggestion to eliminate render-blocking resources and implement asynchronous <em>Google Fonts</em> loading.</p>\n\n<p class=\"SectionBreak\">\n  <a title=\"Back To Top\" href=\"#top\">\n    <img alt=\"section break\"\n      src=\"data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='40' height='13'/%3E\" data-io>\n    <noscript><img alt=\"section break\" src=\"/section-breaks/2.svg\"></noscript></a>\n</p>\n\n<!-- <link href=\"https://fonts.googleapis.com/css?display=swap&amp;family=Gentium+Basic:400,400i,700|Limelight\" rel=\"stylesheet\"> -->\n\n<h2 id=\"async-google-font-loading\">Async Google Font Loading</h2>\n\n<p>The browser will always give CSS the highest priority when opening the page, and begin downloading stylesheets immediately. This is nice, however how do we step up from sync loading to the async one, which does not prevent rendering from happening until the stylesheet is loaded? Let's try to do it with JavaScript. Instead of adding a <span class=\"tm\">link</span> tag, we'll add a script which will create such tag dynamically. This script will be the first thing in our document:</p>\n\n<pre id=\"c6ce5\"><code class=\"xml hljs\">&lt;head&gt;\n  &lt;script&gt;\n    const link = document.createElement('link')\n    link.href = 'https://fonts.googleapis.com/css?' +\n                'display=swap&amp;family=Gentium+Basic:400,400i,700|Limelight'\n    link.rel = 'stylesheet'\n    document.head.appendChild(link)\n  &lt;/script&gt;\n  &lt;!-- other elements --&gt;\n&lt;/head&gt;</code></pre>\n\n<p>Now because the browser does not know that the stylesheet will be embedded, it will not start downloading it straight away like in the previous case. Instead, it will wait until the  script is evaluated to begin the download. What is more, it will continue parsing HTML, and block the main thread so that if the stylesheet is not downloaded quickly, it will have to wait to be inserted until the end of the initial page render.</p>\n\n</div></div></div>\n<div class=\"container-fluid position-relative\">\n  <div class=\"row\">\n    <div class=\"order-2 d-flex align-items-center justify-content-center flex-column mb-3 p-3 rounded position-relative overflow-hidden col\" id=\"fig-75046\">\n      <div class=\" Parallax\" data-loading style=\"z-index: -1;\" id=\"c709f3\"></div>\n      <div style=\"z-index: -1;\" class=\"Parallax\"></div>\n      <noscript>\n        <div class=\" Parallax\" style=\"background-image: url(/img/letters/background.png); z-index: -1;\"></div>\n      </noscript>\n      <p class=\"text-center\">\n        <img class=\"border rounded img-fluid\" alt=\"Figure 4: Loading Google Font asynchronously with JavaScript script tag.\" src=\"data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='731' height='673'/%3E\" data-io>\n        <noscript>\n          <img class=\"border rounded img-fluid\" alt=\"Figure 4: Loading Google Font asynchronously with JavaScript script tag.\" src=\"best-google-font/graphics/dev2.png\">\n        </noscript>\n      </p>\n      <h5 id=\"figure-4-loading-google-font-asynchronously-with-javascript-script-tag\"\n        class=\"m-0 d-inline-block\" style=\"background: white;\">\n        Figure 4: Loading Google Font asynchronously with JavaScript script tag.\n      </h5>\n    </div>\n  </div>\n  <div class=\"position-absolute\" style=\"opacity: 0; top: 1rem; right: 1rem;\" id=\"cccdc\">\n    <a class=\"btn btn-danger\" href=\"#\">Go Back</a>\n  </div>\n</div>\n<div class=\"container\"><div class=\"row\"><div class=\"col\">\n\n<div class=\"mb-3 Revision\">\n  <ol style=\"background-image: url('../articles/img/sketch-yellow.svg');\">\n    \n      <img class=\"pr-2 float-left\" alt=\"reflow animation\" src=\"data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='270' height='170'/%3E\" data-io>\n      <noscript>\n        <img class=\"pr-2 float-left\" alt=\"reflow animation\" src=\"best-google-font/gif/reflow.gif\">\n      </noscript>\n      <li>The stylesheet doesn't gets downloaded immediately like it would with a <span class=\"tm\">link</span> tag, and is loaded only after the browser already parsed HTML and began its job of first page render (Run Microtasks + Layout). During this time, the thread is blocked (semi-opaque orange rectangle), so the stylesheet has to wait before being inserted.<br><br></li>\n      <li>The stylesheet is finally applied which leads to quite expensive layout reflow taking <span style=\"color:green\">84ms</span>. Despite the fact that the fonts are not loaded at all, and there will be no visual change to the page, the browser still recalculates styles and does a reflow. It's an unnecessary work and a waste of valuable ms (the yellow \"evaluate scripts\" job just before the layout is scripts evaluated at the bottom of the page that also block main thread thus delaying this layout).<br><br></li>\n      <li>Finally, like in the previous experiment, fonts arrive one by one, and cause 2 new layout reflows.</li>\n    \n  </ol>\n  <div class=\"position-absolute\" style=\"width: 1rem; bottom: 0px; top: 0px; right: 1rem; border-left: 1px solid #ec6a9d;\">\n    <img src=\"/img/arrows.svg\">\n  </div>\n</div>\n\n<p>This strategy allows to actually load <em>Google Fonts</em> asynchronously and solves the <em>Lighthouse</em> warning. However, it introduced an extra reflow due to the stylesheet insertion that happens after the initial render. There are additional improvements that we could make to the page. We can use the preload hint to make the browser download the stylesheet immediately, in hope that dynamically inserted element will be able to pick up that style:</p>\n\n<pre id=\"c6ce51\"><code class=\"xml hljs\">&lt;head&gt;\n  &lt;link rel=\"dns-prefetch\" href=\"//fonts.googleapis.com\"&gt;\n  &lt;link rel=\"preconnect\" href=\"https://fonts.gstatic.com\" crossorigin&gt;\n  &lt;link rel=\"preload\" as=\"style\" crossorigin\n    href=\"https://fonts.googleapis.com/css?display=swap&amp;family=Gentium+Basic:400,400i,700|Limelight\"&gt;\n  &lt;script&gt;\n    const link = document.createElement('link')\n    link.href = 'https://fonts.googleapis.com/css?' +\n                'display=swap&amp;family=Gentium+Basic:400,400i,700|Limelight'\n    link.rel = 'stylesheet'\n    link.crossOrigin = 'crossorigin' // add crossorigin\n    document.head.appendChild(link)\n  &lt;/script&gt;\n  &lt;!-- other elements --&gt;\n&lt;/head&gt;</code></pre>\n\n<p>OK we've got it! We had to add a <span class=\"tm\">crossOrigin</span> attribute to both links (in markup and in JS) since the style comes from another domain and preload links have to respect that, and the style link has to match preload link's <em>crossorigin</em>.</p>\n\n</div></div></div>\n<div class=\"container-fluid position-relative\">\n  <div class=\"row\">\n    <div class=\"order-2 d-flex align-items-center justify-content-center flex-column mb-3 p-3 rounded position-relative overflow-hidden col\" id=\"fig-57253\">\n      <div class=\" Parallax\" data-loading style=\"z-index: -1;\" id=\"c709f4\"></div>\n      <div style=\"z-index: -1;\" class=\"Parallax\"></div>\n      <noscript>\n        <div class=\" Parallax\" style=\"background-image: url(/img/letters/background.png); z-index: -1;\"></div>\n      </noscript>\n      <p class=\"text-center\">\n        <img class=\"border rounded img-fluid\" alt=\"Figure 5: Loading Google Font asynchronously with a script and preload tag.\" src=\"data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='731' height='673'/%3E\" data-io>\n        <noscript>\n          <img class=\"border rounded img-fluid\" alt=\"Figure 5: Loading Google Font asynchronously with a script and preload tag.\" src=\"best-google-font/graphics/dev3.png\">\n        </noscript>\n      </p>\n      <h5 id=\"figure-5-loading-google-font-asynchronously-with-a-script-and-preload-tag\"\n        class=\"m-0 d-inline-block\" style=\"background: white;\">\n        Figure 5: Loading Google Font asynchronously with a script and preload tag.\n      </h5>\n    </div>\n  </div>\n  <div class=\"position-absolute\" style=\"opacity: 0; top: 1rem; right: 1rem;\" id=\"c632c\">\n    <a class=\"btn btn-danger\" href=\"#\">Go Back</a>\n  </div>\n</div>\n<div class=\"container\"><div class=\"row\"><div class=\"col\">\n\n<div class=\"mb-3 Revision\">\n  <ol style=\"background-image: url('../articles/img/sketch-yellow.svg');\">\n    \n      <li>\n        <img style=\"float: right;\" id=\"Ball\" alt=\"stylesheet before render animation\" src=\"data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='300' height='131'/%3E\" data-io>\n        <noscript>\n          <img style=\"float: right;\" id=\"Ball\" alt=\"stylesheet before render animation\" src=\"best-google-font/gif/render.gif\">\n        </noscript>\n        The stylesheet is downloaded straight away and inserted before the initial render. There's no reflow due to stylesheet being inserted after first pain like previously, because the preload link allowed us to download the stylesheet much faster than just using JavaScript.\n      </li>\n      <li>The fonts arrive at the same time, and cause a single reflow only.</li>\n    \n  </ol>\n  <div class=\"position-absolute\" style=\"width: 1rem; bottom: 0px; top: 0px; right: 1rem; border-left: 1px solid #ec6a9d;\">\n    <img src=\"/img/arrows.svg\">\n  </div>\n</div>\n\n<p>That's good, and we've achieved the result we wanted, that is to load <em>Google Fonts</em> asynchronously. However, from the graph above we can see a gap between fonts starting to download, and the stylesheet arriving, i.e., fonts will begin do download only just prior to the layout task despite the stylesheet referencing them being available for quite some time already, and we'll look into this issue below, but that's how the browser works, and nothing to do with our setup.</p>\n\n<p>Another thing we need to do is to add a polyfill for users who disabled <em>JavaScript</em> execution.</p>\n\n<pre id=\"c6ce52\"><code class=\"xml hljs\">&lt;head&gt;\n    &lt;link rel=\"preload\" ...&gt;\n    &lt;script&gt;\n      const link = document.createElement('link')\n      // ...\n    &lt;/script&gt;\n    &lt;!-- async font loading polyfill --&gt;\n    &lt;noscript&gt;\n      &lt;link rel=\"stylesheet\" crossorigin\n        href=\"https://fonts.googleapis.com/css?display=swap&amp;family=Gentium+Basic:400,400i,700|Limelight\"&gt;\n    &lt;/noscript&gt;\n  &lt;/head&gt;</code></pre>\n\n<p>Despite the working version of async web font stylesheet loading (thus achieving the goal), we assume that the connection is good, and that the stylesheet will be able to download prior to initial page render. Moreover, I've been testing the webpage with another external stylesheet, which loads very fast on localhost, but in reality it would actually take some time and block the browser. If the styles were embedded onto the page, so that there are no render-blocking resources, the browser would not have enough time to download the <em>Google Font</em> stylesheet prior to first render. Therefore, I've simulated a situation when:</p>\n\n<ul>\n  <li>The connection is slower than standard DSL/cable internet (fast 3G preset).</li>\n  <li>There are no blocking resources such as external CSS that prevent direct page rendering.</li>\n</ul>\n\n</div></div></div>\n<div class=\"container-fluid position-relative\">\n  <div class=\"row\">\n    <div class=\"order-2 d-flex align-items-center justify-content-center flex-column mb-3 p-3 rounded position-relative overflow-hidden col\" id=\"fig-45018\">\n      <div class=\" Parallax\" data-loading style=\"z-index: -1;\" id=\"c709f5\"></div>\n      <div style=\"z-index: -1;\" class=\"Parallax\"></div>\n      <noscript>\n        <div class=\" Parallax\" style=\"background-image: url(/img/letters/background.png); z-index: -1;\"></div>\n      </noscript>\n      <p class=\"text-center\">\n        <img class=\"border rounded img-fluid\" alt=\"Figure 6: Loading google font asynchronously on slow connection causes reflow.\" src=\"data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='731' height='579'/%3E\" data-io>\n        <noscript>\n          <img class=\"border rounded img-fluid\" alt=\"Figure 6: Loading google font asynchronously on slow connection causes reflow.\" src=\"best-google-font/graphics/dev4.png\">\n        </noscript>\n      </p>\n      <h5 id=\"figure-6-loading-google-font-asynchronously-on-slow-connection-causes-reflow\"\n        class=\"m-0 d-inline-block\" style=\"background: white;\">\n        Figure 6: Loading google font asynchronously on slow connection causes reflow.\n      </h5>\n    </div>\n  </div>\n  <div class=\"position-absolute\" style=\"opacity: 0; top: 1rem; right: 1rem;\" id=\"c458c\">\n    <a class=\"btn btn-danger\" href=\"#\">Go Back</a>\n  </div>\n</div>\n<div class=\"container\"><div class=\"row\"><div class=\"col\">\n\n<div class=\"mb-3 Revision Reverse\">\n  <ol style=\"background-image: url('../articles/img/sketch-yellow.svg');\">\n    \n      <li>\n        <img class=\"pr-2\" style=\"float: left;\" alt=\"stylesheet is blocked by render\" src=\"data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='250' height='105'/%3E\" data-io>\n        <noscript>\n          <img class=\"pr-2\" style=\"float: left;\" alt=\"stylesheet is blocked by render\" src=\"best-google-font/gif/stylesheet.gif\">\n        </noscript>\n        The page starts rendering as soon as all HTML arrives, but the stylesheet starts to download even before that. Because the connection is slow, the stylesheet arrives during the time when the main thread is blocked by rendering (semi-opaque orange rectangle, light-purple line), so it has to wait for rendering to complete (purple line). When that happens, it's inserted into DOM and triggers a reflow.\n      </li>\n      <li>The first font arrives, triggers reflow.</li>\n      <li>The all other font arrive and trigger reflow and repaint.</li>\n    \n  </ol>\n  <div class=\"position-absolute\" style=\"width: 1rem; bottom: 0px; top: 0px; right: 1rem; border-left: 1px solid #ec6a9d;\">\n    <img src=\"/img/arrows.svg\">\n  </div>\n</div>\n\n<p>So the next step is to make sure that there's only one reflow for the style and fonts. As a side note, there's a technique outlined on the <a target=\"_blank\" rel=\"noopener\" style=\"color: #7b913c !important;; text-decoration: underline;\"\n   href=\"https://alligator.io/html/preload-prefetch/\">\n   <span style=\"display:inline-block\" class=\"position-relative\" id=\"cde7b\">\n     <img class=\"img-fluid\" alt=\"alligator\" src=\"data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='74' height='36'/%3E\" data-io>\n     <noscript><img class=\"img-fluid\" alt=\"alligator\" src=\"best-google-font/graphics/croc.png\"></noscript>\n   </span>Alligator blog: Preload and Prefetch</a> that contracts the JS into a one-liner:</p>\n\n<pre id=\"c16f71\"><code class=\"xml hljs\">&lt;link\n  rel=\"preload\"\n  as=\"style\"\n  onload=\"this.rel = 'stylesheet'\"\n  href='https://fonts.googleapis.com/css?display=swap&amp;family=Gentium+Basic:400,400i,700|Limelight'&gt;</code></pre>\n\n<p>I think the <span class=\"tm\">onload</span> attribute must be <span class=\"tm\">onload=&quot;this.rel = 'stylesheet'; this.onload = null&quot;</span>, otherwise once the preload link is changed into a stylesheet link, the onload will be triggered again. Although theoretically, setting the rel attribute to <span class=\"tm\">stylesheet</span> when it's already a <span class=\"tm\">stylesheet</span> shouldn't cause problems, I used to get the stylesheet downloaded twice. However now I struggle to reproduce this and I think it's rather to do with internal browser logic, or maybe the browser got updated.</p>\n\n<!-- <fig src=\"./graphics/dev5.png\" alt=\"Stylesheet downloaded twice.\" /> -->\n\n<p>Never mind still, it doesn't hurt to remove the <span class=\"tm\">onload</span> attribute by setting it to <span class=\"tm\">null</span>. Additionally, this <span class=\"tm\">onload</span> attribute solution requires a polyfill for browsers that don't support preload which I'll show in the second part, but what I'm really concerned here is <strong>WHEN</strong> the onload is fired. Let's add some performance markers so that we can see a detailed breakdown on the process with the <span class=\"tm\">onload</span> method.</p>\n\n<pre id=\"c6ce53\"><code class=\"xml hljs\">&lt;head&gt;\n  &lt;script&gt;\n    performance.mark('start-stylesheet');\n  &lt;/script&gt;\n\n  &lt;link rel=\"preload\" as=\"style\" crossorigin\n    href=\"https://fonts.googleapis.com/css?display=swap&amp;family=Gentium+Basic:400,400i,700|Limelight\"\n    onload=\"\n    performance.measure('link-onload', 'start-stylesheet');\n    performance.mark('apply-stylesheet');\n    this.onload = () =&gt; {\n      performance.measure('stylesheet-onload', 'apply-stylesheet');\n    };\n    this.rel = 'stylesheet'\n  \"&gt;\n  &lt;!-- rest of head --&gt;\n&lt;/head&gt;\n&lt;body&gt;\n  &lt;script&gt;\n    performance.mark('start-body')\n    performance.mark('start-body2')\n\n    // poll performance every 10ms\n    const i = setInterval(() =&gt; {\n      performance.measure('layout block proof', 'start-body2')\n      performance.mark('start-body2')\n    }, 10)\n\n    window.addEventListener('DOMContentLoaded', () =&gt; {\n      clearInterval(i)\n      performance.measure('layout block', 'start-body')\n    })\n  &lt;/script&gt;\n  &lt;!-- rest of body --&gt;\n&lt;/body&gt;</code></pre>\n\n<p>The <span class=\"tm\">performance.measure</span> function is a very handy util to add markers to the timeline to visualise the break-down. We're going to measure WHEN the <span class=\"tm\">onload</span> event fired, and compare it to when the preload actually finished. One might assume that these points should follow one another (onload after download), however don't forget to account for the lock on the main thread during the initial render (I've said this phrase so many times now, it just shows that it's an important takeaway point).</p>\n\n<p>Just at the start of the body, I added an interval to fire every 10ms to draw a bar (<span class=\"tm\">layout block proof</span>) on the performance graph. If the thread is locked, this time will not be 10ms, as the interval will have to wait until it can fire. The second bar <span class=\"tm\">layout block</span> will stretch from when parsing of HTML began until it finished. Finally, as the very first thing I'm going to measure when the preload began and finished as <span class=\"tm\">link-onload</span> bar, after which the preload will be converted into a stylesheet. <a target=\"_blank\" class=\"btn btn-sm btn-warning\" href=\"/exp/google-font/exp.html\">Experiment Link</a></p>\n\n</div></div></div>\n<div class=\"container-fluid position-relative\">\n  <div class=\"row\">\n    <div class=\"order-2 d-flex align-items-center justify-content-center flex-column mb-3 p-3 rounded position-relative overflow-hidden col\" id=\"fig-65987\">\n      <div class=\" Parallax\" data-loading style=\"z-index: -1;\" id=\"c709f6\"></div>\n      <div style=\"z-index: -1;\" class=\"Parallax\"></div>\n      <noscript>\n        <div class=\" Parallax\" style=\"background-image: url(/img/letters/background.png); z-index: -1;\"></div>\n      </noscript>\n      <p class=\"text-center\">\n        <img class=\"border rounded img-fluid\" alt=\"Figure 7: Performance measurements with onload attribute.\" src=\"data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='835' height='503'/%3E\" data-io>\n        <noscript>\n          <img class=\"border rounded img-fluid\" alt=\"Figure 7: Performance measurements with onload attribute.\" src=\"best-google-font/graphics/dev20.png\">\n        </noscript>\n      </p>\n      <h5 id=\"figure-7-performance-measurements-with-onload-attribute\" class=\"m-0 d-inline-block\"\n        style=\"background: white;\">\n        Figure 7: Performance measurements with onload attribute.\n      </h5>\n    </div>\n  </div>\n  <div class=\"position-absolute\" style=\"opacity: 0; top: 1rem; right: 1rem;\" id=\"c7de0\">\n    <a class=\"btn btn-danger\" href=\"#\">Go Back</a>\n  </div>\n</div>\n<div class=\"container\"><div class=\"row\"><div class=\"col\">\n\n<div class=\"mb-3 Revision Reverse\">\n  <ol style=\"background-image: url('../articles/img/sketch-yellow.svg');\">\n    \n      <li>\n        <img class=\"pl-2 float-right\" alt=\"slow tortoise with onload animation\" src=\"data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='125' height='106'/%3E\" data-io>\n        <noscript>\n          <img class=\"pl-2 float-right\" alt=\"slow tortoise with onload animation\" src=\"best-google-font/gif/tortoise.gif\">\n        </noscript>\n        The stylesheet is preloaded quickly, however the thread has already been locked as seen by the <span class=\"tm\">layout-block-proof</span> yellow bar, which spawns 462ms instead of 10ms interval I'd set. The preload is finished, however we can't convert it into a stylesheet, because the thread is blocked, and have to wait until it's freed.<br><br>\n        <!-- The stylesheet is preloaded quite quickly, even before \"Run microtasks\" howev<br><br>er it's not applied until the first render and layout which is indicated by its continuos \"error\" bar ---| that ends at the layout. -->\n      </li>\n      <li>The thread is freed, and the preload link becomes a stylesheet in 50ms. This triggers fonts download and a reflow. Again, the reflow is unnecessary as no fonts are yet downloaded. Maybe <em>Chrome</em> developers can potentially address this internally.<br><br></li>\n      <li>Fonts arrive and trigger 2 reflows.</li>\n    \n  </ol>\n  <div class=\"position-absolute\" style=\"width: 1rem; bottom: 0px; top: 0px; right: 1rem; border-left: 1px solid #ec6a9d;\">\n    <img src=\"/img/arrows.svg\">\n  </div>\n</div>\n\n<p>Let's compare that to the implementation using a standalone script tag rather than the <span class=\"tm\">onload</span> attribute. I'm going to add 100ms timeout so that the preload event is visible on the timeline. Remember, we added the stylesheet only after the <span class=\"tm\">onload</span> event fired previously. Now, using the script tag, we're adding the stylesheet right away. <a target=\"_blank\" class=\"btn btn-sm btn-warning\" href=\"/exp/google-font/exp2.html\">Experiment Link</a> (might need x6 CPU throttling to reproduce).</p>\n\n<pre id=\"c6ce54\"><code class=\"xml hljs\">&lt;head&gt;\n  &lt;script&gt;\n    performance.mark('start-preload');\n  &lt;/script&gt;\n\n  &lt;link rel=\"preload\" as=\"style\" crossorigin\n    href=\"https://fonts.googleapis.com/css?display=swap&amp;family=Gentium+Basic:400,400i,700|Limelight\"\n    onload=\"performance.measure('preload-onload', 'start-preload')\"\n  &gt;\n  &lt;script&gt;\n    const link = document.createElement('link')\n    link.href = 'https://fonts.googleapis.com/css?display=swap&amp;family=Gentium+Basic:400,400i,700|Limelight'\n    link.rel = 'stylesheet'\n    link.crossOrigin = 'crossorigin'\n    performance.mark('add-stylesheet')\n    document.head.appendChild(link)\n    link.onload = () =&gt; {\n      performance.measure('stylesheet-onload', 'add-stylesheet');\n    }\n  &lt;/script&gt;\n  &lt;!-- rest of head --&gt;\n&lt;/head&gt;\n&lt;body&gt;\n  &lt;script&gt;\n    performance.mark('start-body')\n    performance.mark('start-body2')\n    // layout measurements as before\n  &lt;/script&gt;\n&lt;/body&gt;</code></pre>\n\n<!-- <add-file>img/letters/background.png</add-file> -->\n\n</div></div></div>\n<div class=\"container-fluid position-relative\">\n  <div class=\"row\">\n    <div class=\"order-2 d-flex align-items-center justify-content-center flex-column mb-3 p-3 rounded position-relative overflow-hidden col\" id=\"fig-82466\">\n      <div class=\" Parallax\" data-loading style=\"z-index: -1;\" id=\"c709f7\"></div>\n      <div style=\"z-index: -1;\" class=\"Parallax\"></div>\n      <noscript>\n        <div class=\" Parallax\" style=\"background-image: url(/img/letters/background.png); z-index: -1;\"></div>\n      </noscript>\n      <p class=\"text-center\">\n        <img class=\"border rounded img-fluid\" alt=\"Figure 8: Async stylesheet loading with a script tag instead of onload attribute.\" src=\"data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='848' height='503'/%3E\" data-io>\n        <noscript>\n          <img class=\"border rounded img-fluid\" alt=\"Figure 8: Async stylesheet loading with a script tag instead of onload attribute.\" src=\"best-google-font/graphics/dev21.png\">\n        </noscript>\n      </p>\n      <h5 id=\"figure-8-async-stylesheet-loading-with-a-script-tag-instead-of-onload-attribute\"\n        class=\"m-0 d-inline-block\" style=\"background: white;\">\n        Figure 8: Async stylesheet loading with a script tag instead of onload attribute.\n      </h5>\n    </div>\n  </div>\n  <div class=\"position-absolute\" style=\"opacity: 0; top: 1rem; right: 1rem;\" id=\"c5040\">\n    <a class=\"btn btn-danger\" href=\"#\">Go Back</a>\n  </div>\n</div>\n<div class=\"container\"><div class=\"row\"><div class=\"col\">\n\n<div class=\"mb-3 Revision\">\n  <ol style=\"background-image: url('../articles/img/sketch-yellow.svg');\">\n    \n      <li>\n        <img class=\"pr-2 float-left\" alt=\"fast hire running with script animation\" src=\"data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='150' height='118'/%3E\" data-io>\n        <noscript>\n          <img class=\"pr-2 float-left\" alt=\"fast hire running with script animation\" src=\"best-google-font/gif/hare1.gif\">\n        </noscript>\n        The stylesheet link is added to the DOM immediately after starting to parse HTML using the script tag. This is pretty much exactly the same as the sync version, but without blocking the page!\n        It arrives before the browser applied the lock, and can be used in the first layout, despite the <span class=\"tm\">onload</span> event not having fired on either the stylesheet or preload links.<br><br>\n      </li>\n      <li>The stylesheet is applied during the first render, and fonts begin download.<br><br></li>\n      <li>The initial paint is done, main thread is freed and the preload event fires on our <span class=\"tm\">link rel=&quot;preload&quot;</span> element (<em>preload-onload</em> yellow bar). Compared to the previous case, where we'd inserted the stylesheet only at this point, causing a reflow, here we avoided the reflow and are already halfway through font-downloading.</li>\n    \n  </ol>\n  <div class=\"position-absolute\" style=\"width: 1rem; bottom: 0px; top: 0px; right: 1rem; border-left: 1px solid #ec6a9d;\">\n    <img src=\"/img/arrows.svg\">\n  </div>\n</div>\n\n<p><strike>Hare</strike> Here, we've managed to insert the link tag with the stylesheet into DOM without the cost of reflow and without having to wait for <span class=\"tm\">onload</span> event which most certainly happens only after the layout: on the graph above it can be seen that even though the preload finished before the lock, the <span class=\"tm\">onload</span> event didn't fire. The Run Microtasks and first Layout time increased so that the lock now takes 100ms longer, but I'm not sure if that's to do with styles, or just a fluke. Also if the stylesheet arrived when the lock was already set, it would not have been applied, so this use case is for when the web font styles are downloaded quickly, in say 100ms, but initial parsing takes longer, e.g., 150ms. On modern machines rendering should be really fast, but for older ones and devices this is still applicable, therefore think it's worth targeting this scenario and writing the proper script instead of <span class=\"tm\">onload</span> <em>rel</em> substitution.</p>\n\n<div class=\"position-relative\" id=\"c716e\">\n  <p class=\"p-2 rounded\" style=\"border: 1px dashed #decdb9; margin-left: 2rem; margin-right: 2rem; background: linear-gradient(45deg, white, #e3d6ce);\">\n    <img class=\"mt-3 mr-3\" style=\"width:120px\" alt=\"finger pointer\" src=\"data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='120' height='42'/%3E\" data-io>\n    <noscript>\n      <img class=\"mt-3 mr-3\" style=\"width:120px\" alt=\"finger pointer\" src=\"avatar/pointer.svg\">\n    </noscript>\n    \n      Don't use the <span class=\"tm\">onload</span> attribute on a link element with a web font stylesheet to swap its <em>rel</em> from <strong>preload</strong> to <strong>stylesheet</strong>. Even if the stylesheet was ready before the initial layout started, the <span class=\"tm\">onload</span> event will only fire after it, causing a reflow due to new styles. It's better to add a stylesheet dynamically with <em>JavaScript</em> in a script tag just underneath the preload element, so that it's immediately injected into DOM during the initial parsing of HTML and will not impose a cost of a reflow that has no effect due to fonts not being available yet.\n    \n  </p>\n  <div class=\"position-absolute\" style=\"z-index:-1;top:0;left:0;bottom:0;right:0\"></div>\n</div>\n\n<!-- <p>\n  Finally, I kept saying \"fonts arrive at different times\" and cause separate reflows, however notice how on the above graph ALL fonts are actually downloaded by ~700ms (the green rectangles), but the first one is flushed first separately from other ones &mdash; that's a question to the browser why this happens.\n</p> -->\n\n<!-- <p>\n  OK we're done with figuring out how to load the web fonts asynchronously. It's time for another improvement, that is to collapse all fonts loading into the single reflow.\n</p> -->\n\n<p class=\"SectionBreak\">\n  <a title=\"Back To Top\" href=\"#top\">\n    <img alt=\"section break\"\n      src=\"data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='28' height='9'/%3E\" data-io>\n    <noscript><img alt=\"section break\" src=\"/section-breaks/3.svg\"></noscript></a>\n</p>\n\n<h2 id=\"summary-to-part-i\">Summary To Part I</h2>\n\n<p>In the beginning I only knew how to load up Lighthouse, and it showed me the \"eliminate render-blocking resources\" warning. I had a vague idea of what it meant, but using the performance tool really helped to visualise the process of how a web page loads. It's a sort of debugger for web pages performance.</p>\n\n<p>I then tried to find out how to load <em>Google Font</em> asynchronously, but there was literally just one method, as outlined on the <em>Alligator</em> website I gave a link to above. I went on to explore, what adding the font really adds in terms of performance, and how to optimise it. All the experimenting that I've done helped me to build up the knowledge base of essentials of how a standard web pages load, and here are the main consideration points.</p>\n\n<details style=\"background:linear-gradient(0, #f0f0ff, white);\" class=\"SummaryDetails\" open>\n  <summary style=\"border-bottom: 1px solid; margin-bottom:1rem\"><strong>External Stylesheets VS In-Page Styles</strong></summary>\n  <p><img class=\"float-left px-2\" alt=\"css unblocking thread animation\" src=\"data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='153' height='100'/%3E\" data-io>\n<noscript>\n  <img class=\"float-left px-2\" alt=\"css unblocking thread animation\" src=\"best-google-font/gif/thread.gif\">\n</noscript>\n    Adding a stylesheet with a link will block the page from rendering, and parsing of HTML will only begin when all CSS are loaded. Same applies for JS, unless the <span class=\"tm\">defer/async</span> attributes are set on them, but we've not looked into that here.</p>\n  <p>  <p>Therefore, for landing pages on a website it would make sense to embed the CSS onto the page to achieve maximum performance, whereas for informational webpages it's still OK to share external CSS files.</p></p>\n</details>\n\n    <!-- * It's not only the actual downloading of CSS files that slows down the page, but also gaps that are introduced to the \"parse html\" step. -->\n\n<details style=\"background: linear-gradient(0, #fff0db, white);\" class=\"SummaryDetails\" open>\n  <summary style=\"border-bottom: 1px solid; margin-bottom:1rem\"><strong>Pre-Render Action</strong></summary>\n  <p><img class=\"float-right pl-2\" alt=\"stylesheet before render animation\" src=\"data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='300' height='131'/%3E\" data-io>\n<noscript>\n  <img class=\"float-right pl-2\" alt=\"stylesheet before render animation\" src=\"best-google-font/gif/render.gif\">\n</noscript>\n    After the page is loaded, scripts defined in the head have some time to evaluate and download resources, before initial parsing and layout begin. For pages without external resources, this time is short, for pages with resources, it's longer.</p>\n  <p>  <p>If we inject a stylesheet using JavaScript, it might have time to download prior to initial render, and will be injected into the page organically the first time. If it didn't have time to download, it will cause a reflow. To speed up loading resources from JS, we can add a preload hint to kick off the download immediately with high priority. However, I would recommend writing a separate script to inject the stylesheet, instead of hacking the <span class=\"tm\">onload</span> attribute on the preload link</p>\n    <!-- because such stylesheet will have more chances to --></p>\n</details>\n\n<details style=\"background: linear-gradient(0, #ffdcdc, white);\" class=\"SummaryDetails\" open>\n  <summary style=\"border-bottom: 1px solid; margin-bottom:1rem\"><strong>Initial Layout Block</strong></summary>\n  <p><img class=\"pr-2 float-left\" alt=\"stylesheet is blocked by render\" src=\"data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='250' height='105'/%3E\" data-io>\n<noscript>\n  <img class=\"pr-2 float-left\" alt=\"stylesheet is blocked by render\" src=\"best-google-font/gif/stylesheet.gif\">\n</noscript>\n    Once the initial calculate styles/layout process begins, the main thread is blocked, and scripts that for example started to download resources with XHR, will have to wait until it's done. This can be verified by adding a script with a performance marker that should terminate in a short time, like 100ms, but in reality the measurement will be longer because the script's callback won't be fired until the thread is freed.</p>\n</details>\n\n\n<details style=\"background: linear-gradient(0, #eafff5, white);\" class=\"SummaryDetails\" open>\n  <summary style=\"border-bottom: 1px solid; margin-bottom:1rem\"><strong>Cost Of Reflows</strong></summary>\n  <p><img class=\"pl-2 float-right\" alt=\"reflow animation\" src=\"data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='270' height='170'/%3E\" data-io>\n<noscript>\n  <img class=\"pl-2 float-right\" alt=\"reflow animation\" src=\"best-google-font/gif/reflow.gif\">\n</noscript>\n    Embedding styles after the initial layout will impose a cost of recalculating layout and reflow. In case of web fonts, even if the fonts are not loaded, the reflow will still happen, and block the page, so that the load event is unnecessary delayed. If the style is injected before the initial render, there's no reflow.</p></p>\n  <p>  <p>To step up from sync loading to async loading of CSS, it's best to create a preload link, and define a script right under it that adds the style, instead of updating the <em>rel</em> of the preload link to <strong>stylesheet</strong> to avoid a reflow (see pre-render action).</p></p>\n</details>\n\n<p>Now that we're equipped with this knowledge, we can move on to Part II: <a btn-large class=\"btn btn-warning\" href=\"the-best-way-to-load-google-fonts-asynchronously.html\">\n   The Best Way To Load Google Fonts Asynchronously</a>.</p>\n\n<p>\n  <span id=\"cfc84\"><span class=\"d-inline-block\" style=\"height:36px\" data-loading>Loading sharing buttons...</span><noscript>Please enable JavaScript to Share</noscript></span>\n</p>\n    </div>\n  </div>\n</div>\n",
  "file": "./best-google-font",
  "postAjax": "(function imgPostAjax() {\n  /* eslint-env browser */\n  window['IO']()\n  window['WEBP']()\n})()"
}