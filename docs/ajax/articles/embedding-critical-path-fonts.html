{
  "title": "Embedding Critical Path Fonts",
  "content": "<div class=\"container\">\n  <div class=\"row\">\n    <div class=\"col\">\n\n<h1 id=\"embedding-critical-path-fonts\">Embedding Critical Path Fonts</h1>\n\n<p class=\"H1Lead lead\">\n  &gt; Part III of <em>Advanced Google Font</em>. Go to Part I: <a href=\"how-to-load-google-fonts-asynchronously.html\">How To Load Google Fonts Asynchronously</a> and Part II: <a href=\"the-best-way-to-load-google-fonts-asynchronously.html\">\n   The Best Way To Load Google Fonts Asynchronously</a>.\n</p>\n\n<div class=\"row mb-3\">\n  <div class=\"col-2 col-sm-2 col-lg-1\">\n    <img alt=\"anton photo\"\n      src=\"data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='100' height='100'/%3E\" data-io class=\"rounded img-fluid\" data-src=\"avatar/anton3.jpg\">\n    <noscript><img alt=\"anton photo\" class=\"rounded img-fluid\" src=\"avatar/anton3.jpg\"></noscript>\n  </div>\n  <div style=\"border-bottom: 1px solid grey;\" class=\"col-10 col-sm-7\">\n    <p class=\"text-right\" style=\"color: grey;\">\n      <span>Anton Dmukhovskiy, Senior Software Developer</span><br><span>9 November 2019</span> <span id=\"c9f74\"><span data-loading>Loading sharing buttons...</span><noscript>Please enable JavaScript to Share</noscript></span>\n    </p>\n  </div>\n  <div class=\"col-sm-3 col-lg-4\">\n    Topics:\n    <a class=\"d-block\" href=\"topics.html#page-speed-optimisation\">page speed optimisation</a>\n    <a class=\"d-block\" href=\"topics.html#web-fonts\">web fonts</a>\n  </div>\n</div>\n\n<p>\n  When marking up a page with strong branded fonts, we don't want users to perceive any font swap, at least not for the first thing they see on a page. The resources required for this first thing are said to lay within the critical path. To achieve instant display of a font, it needs to be added to the page in form of a <span class=\"tm\">data:application/font</span>-encoded base64 string. <em>Google Fonts</em> are not capable of that, therefore it's a completely separate solution, but Google will help us a bit. For example, I want to display the heading \"<span class=\"TM1\">Art </span>\n<span class=\"TM1\">Deco‚Ñ¢: </span>\n<span class=\"TM1\">The </span>\n<span class=\"TM1\"><em>Node.JS</em> </span>\n<span class=\"TM1\">Development </span>\n<span class=\"TM1\">Company </span>\n<span class=\"TM1\">In </span>\n<span class=\"TM1\">London</span>\" with the <strong>Limelight</strong> font, therefore I only need these letters to be present. So I call Google to get the font:\n</p>\n\n<pre id=\"c724c\"><code class=\"shell hljs\">chrome:~$ https://fonts.googleapis.com/css?family=Limelight&amp;text= \\\n&gt;  Art Deco‚Ñ¢: The Node.JS Development Company In London</code></pre>\n\n<pre id=\"c1d47\"><code class=\"css hljs\">/* the response */\n@font-face {\n  font-family: 'Limelight';\n  font-style: normal;\n  font-weight: 400;\n  src: local('Limelight'),\n       url(https://fonts.gstatic.com/l/font?kit=XLYkIZL7aopJVbZJHDuYOONArnccUFlCcINMXTbYP4QQRwNnyh7l5gk0xNGO3Z9C2lt3&amp;skey=5080ff57360a6ef&amp;v=v10)\n       format('woff2');\n}</code></pre>\n\n<div class=\"row\">\n  <div class=\"col-md-6\">\n    <p>\n      I grab the link and download it with Node.JS. It will target only <span class=\"tm\">woff2</span> version because of my user-agent, however I'm not bothered to increase the page size by embedding a <span class=\"tm\">woff</span> font also (for IE).\n    </p>\n      <pre id=\"ccdbf\"><code class=\"javascript hljs\">const format = 'woff2'\nconst body = await aqt(link, {\n  binary: true,\n})\nconst base = body.toString('base64')\nconst data = `data:application/font-${format};base64,${base}`</code></pre>\n  </div>\n  <div class=\"col-md-6\">\n    <p>\n      After the data string is constructed, I can upgrade the stylesheet to include this string instead of the url.\n    </p>\n    <pre id=\"c1602\"><code class=\"xml hljs\">&lt;head&gt;\n  &lt;style&gt;\n    @font-face {\n      font-family: 'Limelight';\n      font-style: normal;\n      font-weight: 400;\n      font-display: 'block';\n      src: local('Limelight'),\n           url('data:application/font-woff2;base64,d09GMgABAAAAAAmYAAwAAAAAEAAAAAlKAAEA...=')\n           format('woff2');\n    }\n    h1 {\n      font-family: 'Limelight';\n    }\n  &lt;/style&gt;\n&lt;/head&gt;</code></pre>\n  </div>\n</div>\n\n\n\n</div></div></div>\n<div class=\"container-fluid position-relative\">\n  <div class=\"row\">\n    <div id=\"fig-data-url\" style=\"overflow: hidden;\"\n      class=\"col d-flex align-items-center justify-content-center flex-column mb-3 p-3 rounded position-relative\">\n      <div class=\" Parallax\" data-loading style=\"z-index: -1;\" id=\"c709f3\"></div>\n      <div style=\"z-index: -1;\" class=\"Parallax\"></div>\n      <noscript>\n        <div class=\" Parallax\" style=\"background-image: url(/img/letters/background.png); z-index: -1;\"></div>\n      </noscript>\n      <p class=\"text-center\">\n        <img alt=\"Data-url embedded font also takes time to download.\"\n          src=\"data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='671' height='522'/%3E\" data-io class=\"border rounded img-fluid\"\n          data-src=\"embed-web-fonts/graphics/dev13.gif\">\n        <noscript>\n          <img alt=\"Data-url embedded font also takes time to download.\" class=\"border rounded img-fluid\"\n            src=\"embed-web-fonts/graphics/dev13.gif\">\n        </noscript>\n      </p>\n      <h5 id=\"figure-1-data-url-embedded-font-also-takes-time-to-download\" class=\"m-0 d-inline-block\"\n        style=\"background: white;\">\n        Figure 1: Data-url embedded font also takes time to download.\n      </h5>\n    </div>\n  </div>\n  <div class=\"position-absolute\" style=\"opacity: 0; top: 1rem; right: 1rem;\" id=\"c9412\">\n    <a class=\"btn btn-danger\" href=\"#\">Go Back</a>\n  </div>\n</div>\n<div class=\"container\"><div class=\"row\"><div class=\"col\">\n\n<p>\n  If I refresh the page, depending on the <span class=\"tm\">font-display</span>, I will either witness a FOUT, or a <abbr title=\"Flash of Invisible Text\">FOIT</abbr>. But if I've injected the font into the .html document, shouldn't this not be the case? The problem is that even though the font was embedded with a <span class=\"tm\">data</span> url, it too has to load via the network, as seen in the performance graph below.\n</p>\n\n<p>\n  This result is consistent with the previous experiment, where I've shown that fonts, even declared in a <span class=\"tm\">style</span> tag and not in an external stylesheet, begin to download only when it comes to first <span style=\"background:#a66eeb;\">Recalculate styles</span> job (misleading called <em>RE</em>calculate, it's actually calculate). Here, after the font's download is finished, it forces a reflow and blocks the page for 100ms. It's really not good enough for an advanced optimisation. I'll apply the preload link on the font encoded with into <span class=\"tm\">data:</span> string to solve this problem. I'll use the <span class=\"tm\">onload</span> attribute to get reference to the base64-encoded data so that I don't have to declare it twice (first in the preload link, and second time in the style).\n</p>\n\n<pre id=\"cbdf7\"><code class=\"xml hljs\">&lt;head&gt;\n  &lt;link\n    href=\"data:application/font-woff2;base64,d09GMgABAAAAAAmYAAwAAAAAEAAAAAlKAAEAAAAAAAAAAAAAAAAAAAAAAAAAAA...\"\n    rel=\"preload\" as=\"font\"\n    onload=\"performance.mark('a');window._fontLoaded(this);\n      setTimeout(() =&gt; performance.measure('data font', 'a'), 100)\"&gt;\n\n  &lt;script&gt;\n    window._fontLoaded = function(linkEl) {\n      var data = linkEl.href\n      var s = document.createElement('style')\n      s.innerText = \"@font-face {  font-family: 'Limelight';  font-style: normal;  font-weight: 400;  src: local('Limelight'), url('_URL') format('woff2');}h1 { font-family: 'Limelight' }\".replace('_URL', data)\n      document.head.appendChild(s)\n    }\n  &lt;/script&gt;\n  &lt;!-- a polyfill for when JS is disabled --&gt;\n  &lt;noscript&gt;\n    &lt;link\n      href=\"https://fonts.googleapis.com/css?family=Limelight&amp;amp;text=Art%20Deco%E2%84%A2%3A%20The%20Node.JS%20Development%20Company%20In%20London\" rel=\"stylesheet\"&gt;\n    &lt;style&gt;h1 { font-family: 'Limelight' }&lt;/style&gt;\n  &lt;/noscript&gt;\n&lt;/head&gt;</code></pre>\n\n<p>\n  We <strong>must not</strong> set the <span class=\"tm\">crossorigin</span> attribute on the link, as <em>Safari</em> will error on it, saying the host didn't provide a CORS header (Safari is actually a pretty annoying browser &mdash; it will not clear network cache if there's a preload link for the resource duh ü§¶üèº‚Äç‚ôÄÔ∏è). In case the <strong>preload</strong> <em>rel</em> is not supported, the polyfill can be used, which just calls the <span class=\"tm\">onload</span> method. The <span class=\"tm\">Symbol.iterator</span> polyfill inserted by Closure Compiler (because I did <span class=\"tm\">[...document.head.querySelectorAll('[rel=&quot;preload&quot;][onload]')]</span>) is a bit long but I can't be bothered to do something like <span class=\"tm\">[].forEach.call</span> or whatever other way there is.\n</p>\n\n<pre id=\"c6ce5\"><code class=\"xml hljs\">&lt;script&gt;\n  (function(){function b(){var a=c,g=0;return function(){return g&lt;a.length?{done:!1,value:a[g++]}:{done:!0}}}var d;var e=document.createElement(\"link\").relList;if(e&amp;&amp;e.supports)try{d=e.supports(\"preload\")}catch(a){d=!1}else d=!1;if(!d){var f=document.head.querySelectorAll('[rel=\"preload\"][onload]'),h;\n  if(f instanceof Array)h=f;else{var k,c=f,l=\"undefined\"!=typeof Symbol&amp;&amp;Symbol.iterator&amp;&amp;c[Symbol.iterator];k=l?l.call(c):{next:b()};for(var m,n=[];!(m=k.next()).done;)n.push(m.value);h=n}h.concat().forEach(function(a){if(a.onload)a.onload(a)})};}).call(this);\n&lt;/script&gt;</code></pre>\n\n</div></div></div>\n<div class=\"container position-relative\">\n  <div class=\"row\">\n    <div class=\"col-lg-6 d-flex align-items-center justify-content-center flex-column\">\n      <p>\n        And that's how I got my page opening with the font already present. Unlike in the usual <span class=\"tm\">ÔºústyleÔºû</span> approach with a base64-encoded font in it, here the text is drawn immediately using the font face that I specified, as it was loaded before the initial render. Compare how <a href=\"#fig-data-url\">previously</a>, the font started do download (grey bar) only during the recalculate styles stage, whereas now, it loads as soon as HTML starts parsing. However, it's still not as great as a style preload, which begins even before parsing. There's no way to set a different attribute on the link, like <span class=\"tm\">fetch</span>, load it with XHR and then embed onto the page, because that would lead to another download. But to be honest, I cheated a little bit in this last case, did you notice how? I included an external stylesheet, my <span class=\"tm\">combined.css</span> which slowed down the first render, giving the <span class=\"tm\">data:</span> url a chance to load.\n      </p>\n    </div>\n    <div id=\"fig-9848\" style=\"overflow: hidden;\"\n      class=\"lg-6 col d-flex align-items-center justify-content-center flex-column mb-3 p-3 rounded position-relative\">\n      <div class=\" Parallax\" data-loading style=\"z-index: -1;\" id=\"c709f\"></div>\n      <div style=\"z-index: -1;\" class=\"Parallax\"></div>\n      <noscript>\n        <div class=\" Parallax\" style=\"background-image: url(/img/letters/background.png); z-index: -1;\"></div>\n      </noscript>\n      <p class=\"text-center\">\n        <img alt=\"Achieving critical path font without FOUT/FOIT.\"\n          src=\"data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='671' height='522'/%3E\" data-io class=\"border rounded img-fluid\"\n          data-src=\"embed-web-fonts/graphics/dev14.gif\">\n        <noscript>\n          <img alt=\"Achieving critical path font without FOUT/FOIT.\" class=\"border rounded img-fluid\"\n            src=\"embed-web-fonts/graphics/dev14.gif\">\n        </noscript>\n      </p>\n      <h5 id=\"figure-2-achieving-critical-path-font-without-foutfoit\" class=\"m-0 d-inline-block\"\n        style=\"background: white;\">\n        Figure 2: Achieving critical path font without FOUT/FOIT.\n      </h5>\n    </div>\n  </div>\n  <div class=\"position-absolute\" style=\"opacity: 0; top: 1rem; right: 1rem;\" id=\"ce513\">\n    <a class=\"btn btn-danger\" href=\"#\">Go Back</a>\n  </div>\n</div>\n<div class=\"container\"><div class=\"row\"><div class=\"col\">\n\n<p>\n  [i] <em>The performance timing shows that the preload event fired before the layout, but although it's duration is set to 100ms in code, it took 276ms to complete, which proves that the thread was blocked.</em>\n</p>\n\n\n</div></div></div>\n<div class=\"container position-relative\">\n  <div class=\"row\">\n    <div id=\"fig-74268\" style=\"overflow: hidden;\"\n      class=\"lg-6 col d-flex align-items-center justify-content-center flex-column mb-3 p-3 rounded position-relative\">\n      <div class=\" Parallax\" data-loading style=\"z-index: -1;\" id=\"c709f1\"></div>\n      <div style=\"z-index: -1;\" class=\"Parallax\"></div>\n      <noscript>\n        <div class=\" Parallax\" style=\"background-image: url(/img/letters/background.png); z-index: -1;\"></div>\n      </noscript>\n      <p class=\"text-center\">\n        <img alt=\"Waiting for onload event to fire on preload link.\"\n          src=\"data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='671' height='522'/%3E\" data-io class=\"border rounded img-fluid\"\n          data-src=\"embed-web-fonts/graphics/dev15.gif\">\n        <noscript>\n          <img alt=\"Waiting for onload event to fire on preload link.\" class=\"border rounded img-fluid\"\n            src=\"embed-web-fonts/graphics/dev15.gif\">\n        </noscript>\n      </p>\n      <h5 id=\"figure-3-waiting-for-onload-event-to-fire-on-preload-link\" class=\"m-0 d-inline-block\"\n        style=\"background: white;\">\n        Figure 3: Waiting for onload event to fire on preload link.\n      </h5>\n    </div>\n    <div class=\"col-lg-6 d-flex align-items-center justify-content-center flex-column\">\n      <p>\n        If I embed the <span class=\"tm\">combined.css</span> stylesheet and eliminate this render-blocking resource, I'll loose the gained advantage. On a fast page, the font in the preload link completes its loading process only when the layout began, and the main thread is blocked. We have to wait for the thread to clear after which the <span class=\"tm\">onload</span> event will fire.\n      </p>\n    </div>\n  </div>\n  <div class=\"position-absolute\" style=\"opacity: 0; top: 1rem; right: 1rem;\" id=\"c6965\">\n    <a class=\"btn btn-danger\" href=\"#\">Go Back</a>\n  </div>\n</div>\n<div class=\"container\"><div class=\"row\"><div class=\"col\">\n\n<p>\n  Waiting for <span class=\"tm\">onload</span> cancels out the benefit of preloading the font. So what do we do? I thought of splitting the font into 3 preload links, and loading them in parallel, however that seems too complicated, and also too relies on the the JS event which is inefficient since there's always a risk of running into the main thread block. What worked was not using the <span class=\"tm\">onload</span> at all, and repeating font's data-url string both in the stylesheet and in the preload link. If the font is only 2kb, I don't mind making it 4kb for superb user experience that could land me a client.\n</p>\n\n</div></div></div>\n<div class=\"container position-relative\">\n  <div class=\"row\">\n    <div id=\"fig-80\" style=\"overflow: hidden;\"\n      class=\"lg-6 col d-flex align-items-center justify-content-center flex-column mb-3 p-3 rounded position-relative\">\n      <div class=\" Parallax\" data-loading style=\"z-index: -1;\" id=\"c709f2\"></div>\n      <div style=\"z-index: -1;\" class=\"Parallax\"></div>\n      <noscript>\n        <div class=\" Parallax\" style=\"background-image: url(/img/letters/background.png); z-index: -1;\"></div>\n      </noscript>\n      <p class=\"text-center\">\n        <img alt=\"Preloading data-url font used in stylesheet leads to the most robust optimisation.\"\n          src=\"data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='671' height='522'/%3E\" data-io class=\"border rounded img-fluid\"\n          data-src=\"embed-web-fonts/graphics/dev16.gif\">\n        <noscript>\n          <img alt=\"Preloading data-url font used in stylesheet leads to the most robust optimisation.\"\n            class=\"border rounded img-fluid\" src=\"embed-web-fonts/graphics/dev16.gif\">\n        </noscript>\n      </p>\n      <h5 id=\"figure-4-preloading-data-url-font-used-in-stylesheet-leads-to-the-most-robust-optimisation\"\n        class=\"m-0 d-inline-block\" style=\"background: white;\">\n        Figure 4: Preloading data-url font used in stylesheet leads to the most robust optimisation.\n      </h5>\n    </div>\n    <div class=\"col-lg-6 d-flex align-items-center justify-content-center flex-column\">\n      <p>\n        Chrome will actually complain in the console that the preloaded font was not used, but don't trust him, because it's clearly seen from this graph that the data:application download kicked in much faster than when there was no preload link.\n      </p>\n    </div>\n  </div>\n  <div class=\"position-absolute\" style=\"opacity: 0; top: 1rem; right: 1rem;\" id=\"c8e80\">\n    <a class=\"btn btn-danger\" href=\"#\">Go Back</a>\n  </div>\n</div>\n<div class=\"container\"><div class=\"row\"><div class=\"col\">\n\n<!-- <section-break /> -->\n\n\n<p>\n  Say, someone is looking for a web development company, they click a link to my website, and instantly they see a page that is branded with a font and opens in a split second. Would they be impressed? I think so. In other industries the value of extremely fast loading is probably more subtle and rests on the subconscious appreciation of an aesthetically pleasing fast website. But then again, optimisations like this are only the final polishing steps in producing an amazing website, that above all has impressive design and meaningful and engaging content. Still, here I'm describing it in such details because it helps to understand how browsers work so that we can apply this knowledge (rather than a specific method) in all of our work.\n</p>\n\n<p>\n  <span id=\"c6a73\"><span data-loading>Loading sharing buttons...</span><noscript>Please enable JavaScript to Share</noscript></span>\n</p></div>\n  </div>\n</div>\n",
  "file": "./embed-web-fonts",
  "postAjax": "(function imgPostAjax() {\n  /* eslint-env browser */\n  window['IO']()\n  window['WEBP']()\n})()"
}